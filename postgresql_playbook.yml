---
- name: Install PostgreSQL
  hosts: test_servers
  become: yes
  
  vars:
    db_name: testdb
    db_user: vagrant
    db_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          65353835323064393338373433376161623936626533396536656166383735353030333738636639
          3133386363323033356362313064333861323432373766390a643930326265653235366638646638
          65663965373261333262646232653136646233376638666539383736306433323234303239333232
          6134623233343632660a373734356161396536663066313438306439633633663937386134663733
          6263

  pre_tasks:
  - name: Update apt cache if needed
    apt: update_cache=yes cache_valid_time=86400 #One day

  - name: Install Python packages
    apt: name=python3-psycopg2 state=latest

  - name: Install PostgreSQL packages
    apt: name=postgresql state=latest

  - name: Install ACL to prevent a failure 
    apt: name=acl state=latest

  tasks:
  - name: Start and enable service
    systemd: name=postgresql state=started enabled=yes

  - name: Create test DB
    postgresql_db: state=present name={{ db_name }}
    become: yes
    become_user: postgres

  - name: Create db user
    postgresql_user: state=present name={{ db_user }} password={{ db_password }}
    become: yes
    become_user: postgres

